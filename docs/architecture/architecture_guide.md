# NNRT Architecture Guide

> **Version**: v0.3.1 (Post-Remediation)  
> **Last Updated**: 2026-01-14  
> **Status**: Living Document

This document provides visual explanations of NNRT's core architectural patterns.

---

## Table of Contents

1. [High-Level Pipeline Flow](#1-high-level-pipeline-flow)
2. [NLP Interface Pattern](#2-nlp-interface-pattern)
3. [Pass Architecture](#3-pass-architecture)
4. [IR Data Flow](#4-ir-data-flow)
5. [Entity Resolution Flow](#5-entity-resolution-flow)
6. [Policy Engine Design](#6-policy-engine-design)
7. [Rendering Pipeline](#7-rendering-pipeline)

---

## 1. High-Level Pipeline Flow

The NNRT pipeline transforms narrative text through a series of passes, building up a rich Intermediate Representation (IR).

```
                              NNRT PIPELINE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    INPUT                      PASSES                         OUTPUT
    â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    "I saw the      â”‚                             â”‚
     officer grab   â”‚  p00 â†’ p10 â†’ p20 â†’ p22 â†’   â”‚      Structured
     my arm..."  â”€â”€â–ºâ”‚  p25 â†’ p30 â†’ p32 â†’ p34 â†’   â”‚â”€â”€â–º   JSON + 
                    â”‚  p40 â†’ p50 â†’ p60 â†’ p70 â†’   â”‚      Neutral
                    â”‚  p80                        â”‚      Text
                    â”‚                             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â–²
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   TransformContext   â”‚
                    â”‚   (Accumulating IR)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pass Overview

| Pass | Name | Responsibility |
|------|------|----------------|
| p00 | Normalize | Unicode normalization, whitespace cleanup |
| p10 | Segment | Split into sentences/segments |
| p20 | Tag Spans | Identify semantic spans (quantities, times, etc.) |
| p22 | Classify | Statement type (observation/claim/quote) |
| p25 | Annotate | Add context annotations |
| p30 | Identifiers | Extract names, badges, IDs |
| p32 | Entities | Extract and resolve entities |
| p34 | Events | Extract events and link to entities |
| p40 | Build IR | Assemble complete IR structure |
| p50 | Policy | Apply neutralization rules |
| p60 | Augment | Add metadata |
| p70 | Render | Generate neutral text |
| p80 | Package | Create final output |

---

## 2. NLP Interface Pattern

The NLP layer uses **interfaces** to decouple passes from specific NLP implementations. This enables pluggable backends.

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           NNRT Pipeline             â”‚
                    â”‚                                     â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
   â”‚                                  â”‚                   â”‚
   â–¼                                  â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ p32 â”‚ â”€â”€usesâ”€â”€â–º EntityExtractor â”‚ p34 â”‚ â”€â”€usesâ”€â”€â–º EventExtractor
â””â”€â”€â”€â”€â”€â”˜              â–²            â””â”€â”€â”€â”€â”€â”˜              â–²
                     â”‚                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚         â”‚                       â”‚
    SpacyEntity            StubEntity   SpacyEvent             StubEvent
    Extractor              Extractor    Extractor              Extractor
         â”‚                                  â”‚
         â–¼                                  â–¼
      [spaCy]                            [spaCy]
         
    Future: HuggingFaceExtractor, NativeJarExtractor, JSONInstructExtractor
```

### Interface Definitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     nnrt/nlp/interfaces.py                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   SpanTagger    â”‚  â”‚ EntityExtractor â”‚  â”‚ EventExtractor  â”‚     â”‚
â”‚  â”‚   (Abstract)    â”‚  â”‚   (Abstract)    â”‚  â”‚   (Abstract)    â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ + name: str     â”‚  â”‚ + name: str     â”‚  â”‚ + name: str     â”‚     â”‚
â”‚  â”‚ + tag(text)     â”‚  â”‚ + extract(text) â”‚  â”‚ + extract(text) â”‚     â”‚
â”‚  â”‚   â†’ [SpanTag    â”‚  â”‚   â†’ [EntityEx   â”‚  â”‚   â†’ [EventEx    â”‚     â”‚
â”‚  â”‚      Result]    â”‚  â”‚      tractResult]â”‚  â”‚      tractResult]â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Backend Swapping (for Testing)

```
    Production Mode                    Test Mode
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    p32      â”‚                    â”‚    p32      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                  â”‚
           â”‚ get_extractor()                  â”‚ set_extractor(stub)
           â–¼                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SpacyEntity     â”‚               â”‚ StubEntity      â”‚
    â”‚ Extractor       â”‚               â”‚ Extractor       â”‚
    â”‚                 â”‚               â”‚                 â”‚
    â”‚ (real NLP)      â”‚               â”‚ (returns [])    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    â†’ Full extraction                  â†’ Fast, deterministic tests
```

---

## 3. Pass Architecture

Each pass follows a consistent pattern: receive context, process, return context.

```
                         PASS ANATOMY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   TransformContext                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ segments â”‚ â”‚  spans   â”‚ â”‚ entities â”‚ â”‚ events â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚  â”‚ identif. â”‚ â”‚uncertaintyâ”‚ â”‚  trace   â”‚            â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ input
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       PASS          â”‚
              â”‚                     â”‚
              â”‚  1. Read from ctx   â”‚
              â”‚  2. Process data    â”‚
              â”‚  3. Add to ctx      â”‚
              â”‚  4. Add trace       â”‚
              â”‚                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ output (same ctx, mutated)
                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   TransformContext                   â”‚
    â”‚           (now with more data populated)            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pass Contract

```python
# Every pass follows this signature:
def pass_name(ctx: TransformContext) -> TransformContext:
    """
    1. Read: Access what we need from ctx
    2. Process: Do our work (using interfaces if NLP needed)
    3. Write: Add results to ctx
    4. Trace: Log what we did
    5. Return: Same ctx object
    """
    pass
```

---

## 4. IR Data Flow

The Intermediate Representation builds up through the passes:

```
    p00        p10          p20           p22          p25
    â”€â”€â”€        â”€â”€â”€          â”€â”€â”€           â”€â”€â”€          â”€â”€â”€
    
    raw_text â†’ [Segment] â†’ [Semantic  â†’ [Statement â†’ [Context
                            Span]        Type]        Annotations]
    
    
    p30           p32          p34          p40
    â”€â”€â”€           â”€â”€â”€          â”€â”€â”€          â”€â”€â”€
    
    [Identifier] â†’ [Entity] â†’ [Event] â†’ [Complete IR]
                      â”‚           â”‚          â”‚
                      â”‚           â”‚          â–¼
                      â”‚           â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚           â””â”€â”€â”€â”€â–ºâ”‚ Entity   â”‚â—„â”€â”€ Actor
                      â”‚                 â”‚ Graph    â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚â—„â”€â”€ Target
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    
    p50          p60          p70           p80
    â”€â”€â”€          â”€â”€â”€          â”€â”€â”€           â”€â”€â”€
    
    [Policy   â†’ [Metadata] â†’ [Rendered  â†’ [TransformResult]
     Decision]               Text]
```

### IR Schema Relationships

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       TransformResult                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                               â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    contains    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â”‚  â”‚ Segment â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ SemanticSpan â”‚                  â”‚
    â”‚  â”‚         â”‚                â”‚              â”‚                  â”‚
    â”‚  â”‚ id      â”‚                â”‚ segment_id   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚  â”‚ text    â”‚                â”‚ start_char   â”‚          â”‚       â”‚
    â”‚  â”‚ type    â”‚                â”‚ end_char     â”‚          â”‚       â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚       â”‚
    â”‚       â”‚                            â–²                  â”‚       â”‚
    â”‚       â”‚                            â”‚                  â”‚       â”‚
    â”‚       â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”          â”‚       â”‚
    â”‚       â”‚                     â”‚              â”‚          â”‚       â”‚
    â”‚       â–¼               â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”     â”‚       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  Entity  â”‚   â”‚  Event   â”‚     â”‚       â”‚
    â”‚  â”‚ Identif.â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚   â”‚          â”‚     â”‚       â”‚
    â”‚  â”‚         â”‚          â”‚ mentions â”‚â”€â”€â”€â”¤ actor_id â”‚â”€â”€â”€â”€â”€â”˜       â”‚
    â”‚  â”‚ type    â”‚          â”‚ (span    â”‚   â”‚ target_idâ”‚             â”‚
    â”‚  â”‚ value   â”‚          â”‚  IDs)    â”‚   â”‚ source   â”‚             â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ _spans   â”‚             â”‚
    â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
    â”‚                                                               â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
    â”‚  â”‚ UncertaintyMarkerâ”‚    â”‚  PolicyDecision  â”‚                 â”‚
    â”‚  â”‚                  â”‚    â”‚                  â”‚                 â”‚
    â”‚  â”‚ type             â”‚    â”‚ rule_id          â”‚                 â”‚
    â”‚  â”‚ affected_ids     â”‚    â”‚ action           â”‚                 â”‚
    â”‚  â”‚ description      â”‚    â”‚ original         â”‚                 â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ replacement      â”‚                 â”‚
    â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Entity Resolution Flow

Entity extraction involves NLP detection, resolution, and linking:

```
    INPUT: "The driver hit the passenger. He fled."
    
    
    STEP 1: NLP Detection (Backend)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
        EntityExtractor.extract(text)
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ EntityExtractResult[]:                 â”‚
        â”‚                                        â”‚
        â”‚  [driver]  role=SUBJECT  conf=0.80     â”‚
        â”‚  [passenger] role=SUBJECT conf=0.80   â”‚
        â”‚  [He]      role=SUBJECT  conf=0.60    â”‚
        â”‚            (needs resolution)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    
    STEP 2: Resolution (Pass)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
        recent_entities = [driver, passenger]
        
        For "He" (conf < 0.7 = resolvable pronoun):
        
            candidates = [passenger, driver]  (reversed order)
            
            if len(candidates) > 1:
                â†’ Create UncertaintyMarker (AMBIGUOUS_REFERENCE)
            
            match = candidates[0]  (most recent = passenger)
    
    
    STEP 3: Entity Graph
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                ENTITIES                  â”‚
        â”‚                                         â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  â”‚ ent_001      â”‚  â”‚ ent_002      â”‚    â”‚
        â”‚  â”‚              â”‚  â”‚              â”‚    â”‚
        â”‚  â”‚ label:driver â”‚  â”‚ label:pass.  â”‚    â”‚
        â”‚  â”‚ role:SUBJECT â”‚  â”‚ role:SUBJECT â”‚    â”‚
        â”‚  â”‚ mentions:    â”‚  â”‚ mentions:    â”‚    â”‚
        â”‚  â”‚  [driver]    â”‚  â”‚  [passenger] â”‚    â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  [He]        â”‚    â”‚
        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
        â”‚                                         â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â”‚ UNCERTAINTY                        â”‚ â”‚
        â”‚  â”‚                                    â”‚ â”‚
        â”‚  â”‚ "He" could refer to: driver,       â”‚ â”‚
        â”‚  â”‚ passenger                          â”‚ â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Policy Engine Design

The policy engine applies neutralization rules based on the IR:

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     POLICY ENGINE                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    
    INPUT                     RULES                      OUTPUT
    â”€â”€â”€â”€â”€                     â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ TransformCtx â”‚      â”‚ default.yaml â”‚      â”‚ PolicyDecisionâ”‚
    â”‚              â”‚      â”‚              â”‚      â”‚               â”‚
    â”‚ - segments   â”‚  +   â”‚ - intent     â”‚  =   â”‚ rule_id       â”‚
    â”‚ - entities   â”‚      â”‚ - judgment   â”‚      â”‚ action        â”‚
    â”‚ - events     â”‚      â”‚ - emotion    â”‚      â”‚ original      â”‚
    â”‚ - spans      â”‚      â”‚ - inference  â”‚      â”‚ replacement   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    
    MATCHING FLOW:
    
        "He intentionally grabbed my arm"
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Rule: intent_attribution   â”‚
        â”‚                             â”‚
        â”‚  keywords: [intentionally,  â”‚
        â”‚             deliberately]   â”‚
        â”‚                             â”‚
        â”‚  action: flag               â”‚
        â”‚  severity: high             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PolicyDecision              â”‚
        â”‚                              â”‚
        â”‚  rule_id: intent_attribution â”‚
        â”‚  action: flag                â”‚
        â”‚  original: "intentionally"   â”‚
        â”‚  replacement: null           â”‚
        â”‚  flag: INTENT_ATTRIBUTION    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rule Categories

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    NEUTRALIZATION RULES                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                            â”‚
    â”‚  INTENT ATTRIBUTION          JUDGMENT WORDS                â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
    â”‚  "intentionally"             "suspicious"                  â”‚
    â”‚  "deliberately"              "aggressive"                  â”‚
    â”‚  "tried to"                  "threatening"                 â”‚
    â”‚  "wanted to"                 "uncooperative"               â”‚
    â”‚                                                            â”‚
    â”‚  â†’ Flag or remove            â†’ Flag or reframe             â”‚
    â”‚                                                            â”‚
    â”‚  EMOTION INFERENCE           CERTAINTY MARKERS             â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
    â”‚  "angrily"                   "clearly"                     â”‚
    â”‚  "nervously"                 "obviously"                   â”‚
    â”‚  "aggressively"              "definitely"                  â”‚
    â”‚                                                            â”‚
    â”‚  â†’ Flag or replace           â†’ Flag or soften              â”‚
    â”‚                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Rendering Pipeline

The final rendering stage converts IR to neutral text:

```
                        RENDERING PIPELINE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    TransformContext                      â”‚
    â”‚                                                         â”‚
    â”‚  segments + entities + events + policy_decisions        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    p70_render                            â”‚
    â”‚                                                         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
    â”‚   â”‚ Template      â”‚ OR  â”‚ LLM Constrainedâ”‚              â”‚
    â”‚   â”‚ Renderer      â”‚     â”‚ Renderer       â”‚              â”‚
    â”‚   â”‚               â”‚     â”‚                â”‚              â”‚
    â”‚   â”‚ (rule-based)  â”‚     â”‚ (flan-t5-small)â”‚              â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
    â”‚           â”‚                     â”‚                        â”‚
    â”‚           â”‚   VALIDATION GATE   â”‚                        â”‚
    â”‚           â”‚         â”‚           â”‚                        â”‚
    â”‚           â–¼         â–¼           â–¼                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚   â”‚  validate_llm_output()                       â”‚       â”‚
    â”‚   â”‚                                              â”‚       â”‚
    â”‚   â”‚  - No new facts                              â”‚       â”‚
    â”‚   â”‚  - No hallucination                          â”‚       â”‚
    â”‚   â”‚  - Words grounded in input                   â”‚       â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
    â”‚                         â”‚                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  rendered_text  â”‚
                    â”‚                 â”‚
                    â”‚ "The individual â”‚
                    â”‚ made contact    â”‚
                    â”‚ with the arm."  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### LLM Guardrails

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      LLM POLICY                               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                              â”‚
    â”‚   âœ“ LLMs ASSIST the transformation                           â”‚
    â”‚   âœ— LLMs do NOT DEFINE the transformation                    â”‚
    â”‚                                                              â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚  ALLOWED                        NOT ALLOWED         â”‚    â”‚
    â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
    â”‚   â”‚  â€¢ Rephrase existing facts      â€¢ Add new facts     â”‚    â”‚
    â”‚   â”‚  â€¢ Choose neutral synonyms      â€¢ Infer intent      â”‚    â”‚
    â”‚   â”‚  â€¢ Improve grammar              â€¢ Summarize events  â”‚    â”‚
    â”‚   â”‚  â€¢ Apply policy decisions       â€¢ Make judgments    â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                                                              â”‚
    â”‚   If LLM fails validation â†’ fall back to template rendering  â”‚
    â”‚                                                              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture Principles

### 1. IR as the Domain

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Everything flows through the Intermediate Representation   â”‚
    â”‚                                                             â”‚
    â”‚  INPUT â†’ [IR building passes] â†’ IR â†’ [IR consuming passes] â”‚
    â”‚                                 â–²                           â”‚
    â”‚                                 â”‚                           â”‚
    â”‚                          Single Source                      â”‚
    â”‚                          of Truth                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Pass Isolation

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Pass A  â”‚     â”‚  Pass B  â”‚     â”‚  Pass C  â”‚
    â”‚          â”‚     â”‚          â”‚     â”‚          â”‚
    â”‚ No directâ”‚     â”‚ No directâ”‚     â”‚ No directâ”‚
    â”‚ coupling â”‚     â”‚ coupling â”‚     â”‚ coupling â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ TransformContext â”‚
                 â”‚  (shared state)  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Interface Abstraction

```
    GOAL: Passes don't know (or care) about NLP implementation
    
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚            In the Pass:                  â”‚
            â”‚                                         â”‚
            â”‚    extractor = get_extractor()          â”‚
            â”‚    results = extractor.extract(text)    â”‚
            â”‚                                         â”‚
            â”‚    # Could be spaCy, HuggingFace,       â”‚
            â”‚    # or native JAR - pass doesn't know! â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure Reference

```
nnrt/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ context.py          # TransformContext
â”‚   â”œâ”€â”€ engine.py           # Pipeline orchestration
â”‚   â””â”€â”€ contracts.py        # Pass/Validator interfaces
â”‚
â”œâ”€â”€ ir/
â”‚   â”œâ”€â”€ schema_v0_1.py      # IR data models
â”‚   â””â”€â”€ enums.py            # Type enumerations
â”‚
â”œâ”€â”€ nlp/
â”‚   â”œâ”€â”€ interfaces.py       # SpanTagger, EntityExtractor, EventExtractor
â”‚   â”œâ”€â”€ spacy_loader.py     # Centralized spaCy loading
â”‚   â””â”€â”€ backends/
â”‚       â”œâ”€â”€ spacy_backend.py  # SpaCy implementations
â”‚       â””â”€â”€ stub.py           # Stub for testing
â”‚
â”œâ”€â”€ passes/
â”‚   â”œâ”€â”€ p00_normalize.py    # Text normalization
â”‚   â”œâ”€â”€ p10_segment.py      # Segmentation
â”‚   â”œâ”€â”€ p20_tag_spans.py    # Span tagging
â”‚   â”œâ”€â”€ p22_classify_statements.py
â”‚   â”œâ”€â”€ p25_annotate_context.py
â”‚   â”œâ”€â”€ p30_extract_identifiers.py
â”‚   â”œâ”€â”€ p32_extract_entities.py  # Uses EntityExtractor
â”‚   â”œâ”€â”€ p34_extract_events.py    # Uses EventExtractor
â”‚   â”œâ”€â”€ p40_build_ir.py
â”‚   â”œâ”€â”€ p50_policy.py
â”‚   â”œâ”€â”€ p60_augment_ir.py
â”‚   â”œâ”€â”€ p70_render.py
â”‚   â””â”€â”€ p80_package.py
â”‚
â”œâ”€â”€ policy/
â”‚   â”œâ”€â”€ engine.py           # Policy matching
â”‚   â”œâ”€â”€ loader.py           # YAML rule loading
â”‚   â””â”€â”€ rulesets/           # Default rules
â”‚
â””â”€â”€ output/
    â””â”€â”€ structured.py       # JSON output building
```

---

## Remediation Status (2026-01)

| Issue | Status | Notes |
|-------|--------|-------|
| Shadow Pipeline | âœ… Fixed | p40 is now pure IR assembler |
| Duplicate spaCy Loading | âœ… Fixed | Centralized in `spacy_loader.py` |
| Mention-Span ID Contract | âœ… Fixed | Uses span IDs, not text |
| Interface Bypass | âœ… Fixed | p32/p34 use interfaces |
| Policy Disconnect | ğŸ”´ Pending | Still matches on raw text |
| Hardcoded Models | ğŸ”´ Pending | render/constrained.py |

---

*This document should be updated as the architecture evolves.*
